<!DOCTYPE html>
<html>
<head>
<title>Kitchen Staff Panel - Arabian Nights</title>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<style>
/* Keeping your exact original CSS */
body{ margin:0; font-family:Arial; background:#111; color:white; padding:30px; }
h1{ text-align:center; color:#FFD700; }
.order-card{ background:#1c1c1c; padding:20px; margin:20px 0; border-radius:15px; border-left: 5px solid #FFD700; transition: 0.3s; }
.order-card.pending { border-left-color: #FFD700; }
.order-card.preparing { border-left-color: #FFA500; }
.order-card.ready { border-left-color: #00FF00; }
.order-card.partial { border-left-color: #FFA500; border-left-width: 8px; }
input{ padding:8px; width:80px; border-radius:5px; border:1px solid #333; background:#2c2c2c; color:white; }
button{ background:#FFD700; border:none; padding:8px 15px; cursor:pointer; font-weight:bold; margin-top:10px; margin-right:10px; border-radius:5px; }
button:disabled { opacity:0.5; cursor:not-allowed; }
.status{ font-weight:bold; padding:3px 10px; border-radius:15px; background:#333; }
.item-row { background:#2c2c2c; padding:10px; margin:10px 0; border-radius:8px; border-left: 3px solid transparent; transition: 0.3s; }
.item-row.preparing { border-left-color: #FFA500; background: #2a2a2a; }
.item-row.ready { border-left-color: #00FF00; background: #1a2a1a; }
.item-row .item-status { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 10px; }
.item-status.preparing { background: #FFA500; color: black; }
.item-status.ready { background: #00FF00; color: black; }
.stats-bar { background:#2c2c2c; padding:15px; border-radius:10px; margin-bottom:20px; display:flex; gap:20px; justify-content:space-around; text-align:center; flex-wrap: wrap; }
.stat-item { flex:1; min-width: 100px; }
.stat-value { font-size:24px; font-weight:bold; color:#FFD700; }
.header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
.customer-link { background: #2c2c2c; color: #FFD700; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; border: 1px solid #FFD700; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; }
.customer-link:hover { background: #FFD700; color: #111; transform: translateY(-2px); }
.estimated-time { background: #2c2c2c; padding: 3px 10px; border-radius: 15px; color: #FFD700; font-size: 0.9rem; }
.refresh-btn { background: #2563eb; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-left: 10px; }
.refresh-btn:hover { background: #1d4ed8; }
.progress-badge { font-size: 0.8rem; padding: 2px 8px; border-radius: 12px; background: #333; color: white; margin-left: 10px; }
.filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.filter-btn { background: #2c2c2c; color: white; border: 1px solid #444; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
.filter-btn.active { background: #FFD700; color: black; border-color: #FFD700; }
.filter-btn:hover { background: #444; }
.bulk-actions { background: #2c2c2c; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
.bulk-actions select { padding: 8px; border-radius: 5px; background: #1c1c1c; color: white; border: 1px solid #444; }
</style>
</head>
<body>

<div class="header-bar">
    <h1>üë®‚Äçüç≥ Kitchen Staff Panel</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
        <a href="home.html" class="customer-link" target="_blank">üè† View Customer Menu</a>
        <button onclick="logout()" style="background:#dc2626; color:white;">Logout</button>
    </div>
</div>

<div class="stats-bar" id="stats">
    <div class="stat-item"><div class="stat-value" id="pending-count">0</div><div>Pending</div></div>
    <div class="stat-item"><div class="stat-value" id="preparing-count">0</div><div>Preparing</div></div>
    <div class="stat-item"><div class="stat-value" id="ready-count">0</div><div>Ready</div></div>
    <div class="stat-item"><div class="stat-value" id="partial-count">0</div><div>Partially Ready</div></div>
    <div class="stat-item"><div class="stat-value" id="total-items">0</div><div>Total Items</div></div>
</div>

<div class="filter-bar">
    <button class="filter-btn active" onclick="filterOrders('all')" id="filter-all">All Orders</button>
    <button class="filter-btn" onclick="filterOrders('pending')" id="filter-pending">Pending</button>
    <button class="filter-btn" onclick="filterOrders('preparing')" id="filter-preparing">Preparing</button>
    <button class="filter-btn" onclick="filterOrders('ready')" id="filter-ready">Ready</button>
    <button class="filter-btn" onclick="filterOrders('partial')" id="filter-partial">Partially Ready</button>
</div>

<div class="bulk-actions">
    <span style="color:#FFD700;">‚ö° Multi-Item Management</span>
    <select id="bulk-order-select"><option value="">Select Order</option></select>
    <select id="bulk-category">
        <option value="all">All Items</option>
        <option value="Starters">Starters Only</option>
        <option value="Mains">Mains Only</option>
        <option value="Desserts">Desserts Only</option>
        <option value="Beverages">Beverages Only</option>
    </select>
    <button onclick="bulkMarkPreparing()" style="background:#2563eb;">‚ñ∂Ô∏è Start Selected</button>
    <button onclick="bulkMarkReady()" style="background:#059669;">‚úÖ Mark Selected Ready</button>
</div>

<div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
    <div>
        <span style="color:#059669; font-weight: bold;">üü¢ Live Sync Active</span>
    </div>
    <div style="color:#888;">
        Total Orders: <span id="total-orders">0</span>
    </div>
</div>

<div id="orders"></div>

<script>
if(sessionStorage.getItem("staffLoggedIn") !== "true"){
    window.location.replace("stafflogin.html");
}

function logout(){
    sessionStorage.removeItem("staffLoggedIn");
    window.location.replace("stafflogin.html");
}

if("Notification" in window){
    Notification.requestPermission();
}

// Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAzg6lEGVS-hcedC7ZhWdz0uq1_vtqTCCA",
    authDomain: "arabian-nights-cca24.firebaseapp.com",
    databaseURL: "https://arabian-nights-cca24-default-rtdb.firebaseio.com",
    projectId: "arabian-nights-cca24",
    storageBucket: "arabian-nights-cca24.firebasestorage.app",
    messagingSenderId: "405951495752",
    appId: "1:405951495752:web:cedcf446717f9359b2e27d",
    measurementId: "G-N6ZC0F2J5V"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

let currentFilter = 'all';
let globalOrders = [];

// Listen for live data
database.ref('orders').on('value', (snapshot) => {
    globalOrders = [];
    snapshot.forEach(child => {
        let order = child.val();
        order.key = child.key; // Using Firebase Key
        globalOrders.push(order);
    });
    renderOrders();
});

function renderOrders(){
    let container = document.getElementById("orders");
    updateBulkSelect(globalOrders);
    
    let filteredOrders = filterOrdersByStatus(globalOrders, currentFilter);
    container.innerHTML = "";

    if(filteredOrders.length === 0){
        container.innerHTML = "<div style='text-align:center; padding:50px; background:#1c1c1c; border-radius:15px;'>No orders match the current filter.</div>";
        updateStats(globalOrders);
        document.getElementById('total-orders').textContent = globalOrders.length;
        return;
    }

    document.getElementById('total-orders').textContent = globalOrders.length;

    filteredOrders.sort((a, b) => {
        const statusOrder = { "Pending": 1, "Preparing": 2, "Partial": 3, "Ready": 4 };
        return (statusOrder[a.status] || 5) - (statusOrder[b.status] || 5);
    });

    filteredOrders.forEach((order) => {
        if(!order.itemStatus) {
            order.itemStatus = {};
            order.items.forEach(item => order.itemStatus[item.id] = 'pending');
        }

        let itemStatuses = Object.values(order.itemStatus);
        let allReady = itemStatuses.every(s => s === 'ready');
        let someReady = itemStatuses.some(s => s === 'ready');
        let allPreparing = itemStatuses.every(s => s === 'preparing' || s === 'ready');
        
        let calculatedStatus = "Pending";
        if(allReady) calculatedStatus = "Ready";
        else if(someReady) calculatedStatus = "Partial";
        else if(allPreparing) calculatedStatus = "Preparing";
        
        // Sync status back to firebase if changed
        if (order.status !== calculatedStatus) {
            database.ref('orders/' + order.key).update({ status: calculatedStatus });
        }
        order.status = calculatedStatus;

        if(order.notified === false && order.status === "Pending"){
            if(Notification.permission === "granted"){
                new Notification("üÜï New Order!", {
                    body: `Table ${order.table} - ${order.name} - ${order.items.length} items`,
                    silent: false
                });
            }
            database.ref('orders/' + order.key).update({ notified: true });
        }

        let itemsHTML = "";
        let readyCount = 0;

        order.items.forEach((item) => {
            let timeValue = item.time && item.time !== "Not Set" ? item.time.replace(" mins","") : "";
            let itemStatus = order.itemStatus[item.id] || 'pending';
            if(itemStatus === 'ready') readyCount++;
            
            let statusClass = itemStatus === 'preparing' ? 'preparing' : (itemStatus === 'ready' ? 'ready' : '');
            let statusBadge = itemStatus === 'preparing' ? '<span class="item-status preparing">üë®‚Äçüç≥ Prep</span>' : 
                              (itemStatus === 'ready' ? '<span class="item-status ready">‚úÖ Ready</span>' : '');

            itemsHTML += `
            <div class="item-row ${statusClass}">
                <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap: 10px;">
                    <div style="flex: 1;">
                        <strong>${item.name}</strong> x${item.quantity} 
                        <span style="color:#FFD700">(‚Çπ${item.price * item.quantity})</span>
                        ${statusBadge}
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="number" min="1" value="${timeValue}" placeholder="mins"
                            onchange="setItemTime('${order.key}', ${item.id}, this.value)" style="width:60px;">
                        <span style="color:#888;">mins</span>
                        <button onclick="markItemPreparing('${order.key}', '${item.id}')" 
                            ${itemStatus === 'preparing' || itemStatus === 'ready' ? 'disabled' : ''}
                            style="background:#2563eb; margin:0; padding:5px 10px;">‚ñ∂Ô∏è Prep</button>
                        <button onclick="markItemReady('${order.key}', '${item.id}')" 
                            ${itemStatus === 'ready' ? 'disabled' : ''}
                            style="background:#059669; margin:0; padding:5px 10px;">‚úÖ Ready</button>
                    </div>
                </div>
            </div>`;
        });

        let estimatedTimes = order.items.map(i => i.time ? parseInt(i.time) : 0).filter(t => !isNaN(t) && t > 0);
        let overallEstimate = estimatedTimes.length > 0 ? Math.max(...estimatedTimes) : null;

        let statusColor = order.status === "Ready" ? "#00FF00" : (order.status === "Preparing" || order.status === "Partial" ? "#FFA500" : "#FFD700");
        let statusDisplay = order.status === "Partial" ? `Partial (${readyCount}/${order.items.length})` : order.status;

        container.innerHTML += `
        <div class="order-card ${order.status.toLowerCase()}" style="border-left-color: ${statusColor}">
            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                <div><strong style="font-size: 1.2em;">Table ${order.table}</strong><span style="color:#888; margin-left:10px;">${order.name}</span></div>
                <div><span class="status" style="background: ${statusColor}; color: black;">${statusDisplay}</span></div>
            </div>
            <div style="margin-bottom: 15px; color:#888;">
                <small>Order #${order.id.toString().slice(-6)} ‚Ä¢ ${new Date(order.timestamp).toLocaleTimeString()}</small>
            </div>
            ${itemsHTML}
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="startAllItems('${order.key}')" ${order.status === 'Ready' ? 'disabled' : ''} style="background: #2563eb;">üèÅ Start All</button>
                <button onclick="completeAllItems('${order.key}')" ${order.status === 'Ready' ? 'disabled' : ''} style="background: #059669;">‚úÖ Complete All</button>
            </div>
        </div>`;
    });

    updateStats(globalOrders);
}

// Data Update Functions utilizing Firebase
function markItemPreparing(orderId, itemId) {
    database.ref(`orders/${orderId}/itemStatus/${itemId}`).set('preparing');
}

function markItemReady(orderId, itemId) {
    database.ref(`orders/${orderId}/itemStatus/${itemId}`).set('ready');
}

function startAllItems(orderId) {
    let order = globalOrders.find(o => o.key === orderId);
    if(order) {
        let updates = {};
        order.items.forEach(item => {
            if((order.itemStatus || {})[item.id] !== 'ready') updates[item.id] = 'preparing';
        });
        database.ref(`orders/${orderId}/itemStatus`).update(updates);
    }
}

function completeAllItems(orderId) {
    let order = globalOrders.find(o => o.key === orderId);
    if(order) {
        let updates = {};
        order.items.forEach(item => updates[item.id] = 'ready');
        database.ref(`orders/${orderId}/itemStatus`).update(updates);
    }
}

function setItemTime(orderId, itemId, time) {
    if(!time || time < 1) return;
    let order = globalOrders.find(o => o.key === orderId);
    let itemIndex = order.items.findIndex(i => i.id == itemId);
    if(itemIndex !== -1) {
        database.ref(`orders/${orderId}/items/${itemIndex}`).update({ time: time + " mins" });
    }
}

function bulkMarkPreparing() {
    let orderId = document.getElementById('bulk-order-select').value;
    let category = document.getElementById('bulk-category').value;
    if(!orderId) return alert('Select an order');
    let order = globalOrders.find(o => o.key === orderId);
    let updates = {};
    order.items.forEach(item => {
        if((category === 'all' || item.category === category) && (order.itemStatus || {})[item.id] !== 'ready') {
            updates[item.id] = 'preparing';
        }
    });
    database.ref(`orders/${orderId}/itemStatus`).update(updates);
}

function bulkMarkReady() {
    let orderId = document.getElementById('bulk-order-select').value;
    let category = document.getElementById('bulk-category').value;
    if(!orderId) return alert('Select an order');
    let order = globalOrders.find(o => o.key === orderId);
    let updates = {};
    order.items.forEach(item => {
        if(category === 'all' || item.category === category) updates[item.id] = 'ready';
    });
    database.ref(`orders/${orderId}/itemStatus`).update(updates);
}

// Utility UI Functions
function filterOrdersByStatus(orders, filter) {
    if(filter === 'all') return orders;
    if(filter === 'partial') return orders.filter(o => o.status === 'Partial');
    return orders.filter(o => o.status === filter);
}

function filterOrders(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`filter-${filter}`).classList.add('active');
    renderOrders();
}

function updateBulkSelect(orders) {
    let select = document.getElementById('bulk-order-select');
    select.innerHTML = '<option value="">Select Order</option>';
    orders.forEach(order => {
        select.innerHTML += `<option value="${order.key}">Table ${order.table} - ${order.name}</option>`;
    });
}

function updateStats(orders) {
    let [pending, preparing, ready, partial, totalItems] = [0, 0, 0, 0, 0];
    orders.forEach(order => {
        if(order.status === "Pending") pending++;
        else if(order.status === "Preparing") preparing++;
        else if(order.status === "Ready") ready++;
        else if(order.status === "Partial") partial++;
        if(order.items) totalItems += order.items.length;
    });
    document.getElementById('pending-count').textContent = pending;
    document.getElementById('preparing-count').textContent = preparing;
    document.getElementById('ready-count').textContent = ready;
    document.getElementById('partial-count').textContent = partial;
    document.getElementById('total-items').textContent = totalItems;
}
</script>

</body>
</html>